#!/usr/bin/env bash
#----------------------------------------------------------------------------------------#
# If you encounter any issues with this script, or have suggestions or feature requests, #
# please open an issue at: https://github.com/Muthukumar-Subramaniam/server-hub/issues   #
#----------------------------------------------------------------------------------------#
# lab-rootfs-extender
# Usage:
#   ./lab-rootfs-extender [remote-host/localhost]

source /server-hub/common-utils/color-functions.sh

# --- Config ---
SSH_OPTS="-o LogLevel=QUIET -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
SCRIPT_LOCATION="/server-hub/common-utils/lab-rootfs-extender"

# ----------------------
# Prompt for hostname if not passed
# ----------------------
REMOTE_HOST="${1:-}"

if [[ -z "$REMOTE_HOST" ]]; then
    read -rp "Enter remote hostname [default: localhost]: " REMOTE_HOST
    REMOTE_HOST=${REMOTE_HOST:-localhost}
fi

# ----------------------
# Remote execution logic
# ----------------------
if [[ "$REMOTE_HOST" != "localhost" ]]; then
    print_info "[INFO] Checking SSH connectivity to $REMOTE_HOST..." nskip
    if ! ssh $SSH_OPTS "$REMOTE_HOST" "true" >/dev/null 2>&1; then
        print_error "[ FAILED ]"
        print_error "[ERROR] SSH connection to $REMOTE_HOST failed. Ensure SSH access works."
        exit 1
    fi
    print_success "[ SUCCESS ]"

    print_info "[INFO] Executing lab-rootfs-extender utility on host $REMOTE_HOST..."
    ssh $SSH_OPTS -t "$REMOTE_HOST" "sudo bash $SCRIPT_LOCATION localhost"
    print_info "[INFO] Remote execution completed on $REMOTE_HOST."
    exit 0
fi

# ----------------------
# Local execution logic
# ----------------------
FS_BEFORE=$(df -h / | awk 'NR==2{print $2}')
print_info "[INFO] Root filesystem size before expansion: $FS_BEFORE"

# Ensure growpart is installed
fn_get_growpart() {
    print_info "[INFO] Checking if 'growpart' utility is available..." nskip
    if ! command -v growpart >/dev/null 2>&1; then
        print_warning "[ NOT FOUND ]"
        print_info "[INFO] Creating binary link from lab infra server-hub NFS share..." nskip
        if ! sudo ln -s /server-hub/common-utils/growpart /usr/bin/growpart 2>/dev/null; then
            print_warning "[ FAILED ]"
            print_info "[INFO] Downloading 'growpart' from official repository..." nskip
            if ! sudo curl -fsSL -o /usr/bin/growpart https://raw.githubusercontent.com/canonical/cloud-utils/main/bin/growpart 2>/dev/null; then
                print_error "[ FAILED ]"
                return 1
            else
                sudo chmod +x /usr/bin/growpart
                print_success "[ SUCCESS ]"
                return 0
            fi
        else
            print_success "[ SUCCESS ]"
            return 0
        fi
    else
        print_success "[ SUCCESS ]"
        return 0
    fi
}

ROOT_DEV=$(findmnt -n -o SOURCE /)
print_info "[INFO] Root device: $ROOT_DEV"

# Only XFS supported
FS_TYPE=$(findmnt -n -o FSTYPE /)
if [[ "$FS_TYPE" != "xfs" ]]; then
    print_error "[ERROR] Unsupported filesystem type: $FS_TYPE. This script only supports XFS."
    exit 1
fi

if [[ "$ROOT_DEV" =~ ^/dev/mapper/ ]]; then
    print_info "[INFO] Detected LVM-based root filesystem."

    # Get VG name from LV path
    VG_NAME=$(sudo lvs --noheadings -o vg_name "$ROOT_DEV" | awk '{$1=$1};1')
    print_info "[INFO] Volume Group: $VG_NAME"

    # Get PV (first if multiple)
    PV_PATH=$(sudo pvs --noheadings -o pv_name --select vg_name="$VG_NAME" | awk '{$1=$1};1' | head -n1)
    print_info "[INFO] Physical Volume: $PV_PATH"

    # Get disk and partition number from lsblk
    DISK="/dev/$(lsblk -no pkname "$PV_PATH" | sort | head -n1 | tr -d '[:space:]')"
    PART_NUM=$(lsblk -no partn "$PV_PATH" | tr -d '[:space:]')

    if fn_get_growpart; then
        print_info "[INFO] Growing partition $PV_PATH..." nskip
        if sudo growpart "$DISK" "$PART_NUM" >/dev/null 2>&1; then
            print_success "[ SUCCESS ]"
        else
            print_warning "[ SKIPPED ]"
        fi

        print_info "[INFO] Resizing PV $PV_PATH..." nskip
        if sudo pvresize "$PV_PATH" >/dev/null 2>&1; then
            print_success "[ SUCCESS ]"
        else
            print_error "[ FAILED ]"
        fi

        print_info "[INFO] Extending LV $ROOT_DEV..." nskip
        if sudo lvextend -l +100%FREE "$ROOT_DEV" >/dev/null 2>&1; then
            print_success "[ SUCCESS ]"
        else
            print_warning "[ SKIPPED ]"
        fi

        print_info "[INFO] Extending XFS filesystem on /..." nskip
        if sudo xfs_growfs / >/dev/null 2>&1; then
            print_success "[ SUCCESS ]"
        else
            print_error "[ FAILED ]"
        fi
    else
        print_warning "[WARNING] Skipping partition growth - 'growpart' utility not available."
    fi
else
    print_info "[INFO] Detected non-LVM root filesystem (plain partition)."

    # Get disk and partition number from lsblk
    DISK="/dev/$(lsblk -no pkname "$ROOT_DEV" | sort | head -n1 | tr -d '[:space:]')"
    PART_NUM=$(lsblk -no partn "$ROOT_DEV" | tr -d '[:space:]')

    print_info "[INFO] Disk: $DISK, Partition: $PART_NUM"

    if fn_get_growpart; then
        print_info "[INFO] Growing partition ${DISK}${PART_NUM}..." nskip
        if sudo growpart "$DISK" "$PART_NUM" >/dev/null 2>&1; then
            print_success "[ SUCCESS ]"
        else
            print_warning "[ SKIPPED ]"
        fi

        print_info "[INFO] Extending XFS filesystem on /..." nskip
        if sudo xfs_growfs / >/dev/null 2>&1; then
            print_success "[ SUCCESS ]"
        else
            print_error "[ FAILED ]"
        fi
    else
        print_warning "[WARNING] Skipping partition growth - 'growpart' utility not available."
    fi
fi

FS_AFTER=$(df -h / | awk 'NR==2{print $2}')

if [[ "$FS_BEFORE" == "$FS_AFTER" ]]; then
    print_warning "[WARNING] No change in root filesystem size."
else
    print_info "[INFO] Root filesystem size after expansion: $FS_AFTER"
    print_success "[SUCCESS] Root filesystem successfully expanded!"
fi
