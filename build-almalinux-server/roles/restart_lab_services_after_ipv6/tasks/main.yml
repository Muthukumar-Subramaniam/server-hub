---
# tasks file for restart_lab_services_after_ipv6
- name: Create IPv6 wait script
  become: true
  ansible.builtin.copy:
    dest: /usr/local/bin/wait-for-ipv6.sh
    content: |
      #!/bin/bash
      # Wait for IPv6 address to be configured and stable
      MAX_WAIT=60
      COUNTER=0
      IPV6_ADDRESS="{{ ansible_facts.env.dnsbinder_server_ipv6_address }}"
      
      echo "Waiting for IPv6 address ${IPV6_ADDRESS} to be ready..."
      
      while [ $COUNTER -lt $MAX_WAIT ]; do
        # Check if IPv6 address exists and is not tentative
        if ip -6 addr show eth0 | grep -q "inet6 ${IPV6_ADDRESS}/64 scope global" && \
           ! ip -6 addr show eth0 | grep "${IPV6_ADDRESS}" | grep -q "tentative"; then
          echo "IPv6 address is configured and stable"
          # Additional 2 second grace period
          sleep 2
          exit 0
        fi
        sleep 0.5
        COUNTER=$((COUNTER + 1))
      done
      
      echo "Timeout waiting for IPv6 address"
      exit 1
    mode: '0755'
    owner: root
    group: root

- name: Create lab-services-restart.service
  become: true
  ansible.builtin.copy:
    dest: /etc/systemd/system/lab-services-restart.service
    content: |
      [Unit]
      Description=Restart Lab Services After IPv6 is Ready
      After=network-online.target NetworkManager.service
      Wants=network-online.target
      
      [Service]
      Type=oneshot
      RemainAfterExit=yes
      ExecStart=/usr/local/bin/wait-for-ipv6.sh
      ExecStart=/usr/bin/systemctl restart nginx.service nfs-server.service kea-dhcp6.service chronyd.service named.service
      
      [Install]
      WantedBy=multi-user.target
    mode: '0644'
    owner: root
    group: root

- name: Reload systemd daemon
  become: true
  ansible.builtin.systemd:
    daemon_reload: true

- name: Enable lab-services-restart.service
  become: true
  systemd_service:
    name: lab-services-restart.service
    enabled: true

############################# EOF ##############################
